PIPELINE MICROBIOTA ANALYSIS
Bioinformatic pipeline to analyze microbiota from Arbacia lixula and Paracentrotus lividus.

Pipeline Pau: https://github.com/paubernado/Urchin_microbiota
#connect to VENUS
ssh intern@161.116.67.159



conda activate qiime2-2022.11

#create a screen

screen -S microbiota_pau_urchins

#open screen

screen -r microbiota_urchins

# exit screen 

control + a i d

FASTQ_DIR="/data/data/microbiota_pau/sequences"

cd "$FASTQ_DIR" || { echo "Folder not found: $FASTQ_DIR"; exit 1; }

# Create manifest header (tab-separated)
printf "sample-id\tforward-absolute-filepath\treverse-absolute-filepath\n" > manifest.tsv

# Loop over forward reads
for fwd in *_R1.fastq.gz; do
  # Extract sample ID by removing _R1.fastq.gz from filename
  sample=${fwd%_R1.fastq.gz}

  # Construct reverse filename
  rev="${sample}_R2.fastq.gz"

  # Check if reverse file exists
  if [[ -f "$rev" ]]; then
    # Append sample line with absolute paths (tab-separated)
    printf "%s\t%s\t%s\n" "$sample" "$(realpath "$fwd")" "$(realpath "$rev")" >> manifest.tsv
  else
    echo "Warning: Reverse file missing for sample $sample"
  fi
done

echo "Manifest created as manifest.tsv in $FASTQ_DIR"

# run it, via a nano txt file
#STEP 1: IMPORT RAW FILES INTO QIIME2
qiime tools import \
  --type 'SampleData[PairedEndSequencesWithQuality]' \
  --input-path manifest.tsv \
  --input-format PairedEndFastqManifestPhred33V2\
  --output-path demux-seqs.qza
#STEP 2: TRIM PRIMERS OFF RAW READS
qiime cutadapt trim-paired \
  --i-demultiplexed-sequences demux-seqs.qza \
  --p-front-f CCTACGGGNGGCWGCAG \
  --p-front-r GACTACHVGGGTATCTAATCC \
  --p-error-rate 0 \
  --o-trimmed-sequences trimmed-seqs.qza

#STEP 3: DENOISE AND CLUSTERING INTO ASV

qiime dada2 denoise-paired \
  --i-demultiplexed-seqs trimmed-seqs.qza \
  --p-trim-left-f 0 \
  --p-trim-left-r 0 \
  --p-trunc-len-f 260 \
  --p-trunc-len-r 260 \
  --p-n-threads 4 \
  --o-representative-sequences rep-seqs-dada2.qza \
  --o-table table-dada2.qza \
  --o-denoising-stats denoising-stats-dada2.qza
#VISUALIZATION AND SUMMARY
qiime feature-table summarize \
--i-table table-dada2.qza \
--o-visualization table-dada2.qzv 

qiime feature-table tabulate-seqs \
--i-data rep-seqs-dada2.qza \
--o-visualization rep-seqs-dada2.qzv
#CREATE FEATURE TABLE WITH METADATA
qiime feature-table summarize \
  --i-table table-dada2.qza \
  --o-visualization table-dada2-summary.qzv \
  --m-sample-metadata-file metadata_final.tsv
#STEP 4: CREATE PHYLOGENY
#ALIGNMENT OF REPRESENTATIVE SEQUENCES
qiime alignment mafft \
  --i-sequences rep-seqs-dada2.qza \
  --o-alignment alignment-rep-seqs.qza 

#MASK HIGHLY VARIABLE NOISY POSITIONS IN ALIGNMENT
qiime alignment mask \
  --i-alignment alignment-rep-seqs.qza \
  --o-masked-alignment masked-alignment-rep-seqs.qza 

#CREATE PHYLOGENY WITH FASTTREE (not rooted?)
qiime phylogeny fasttree \
  --i-alignment alignment-rep-seqs.qza \
  --o-tree not-rooted-tree.qza 

#ROOT PHYLOGENY AT MIDPOINT
qiime phylogeny midpoint-root \
  --i-tree fasttree-alignment-rep-seqs.qza \
  --o-rooted-tree rooted-tree-rep-seqs.qza 
#STEP 5: ASSIGN TAXONOMY WITH TRAINED CLASSIFIER
wget \
-O "silva-138-99-nb-classifier.qza" \
"https://data.qiime2.org/2022.11/common/silva-138-99-nb-classifier.qza"

qiime feature-classifier classify-sklearn \
  --i-classifier silva-138-99-nb-classifier.qza \
  --i-reads rep-seqs-dada2.qza \
  --o-classification taxonomy.qza \
  --p-n-jobs 1 \
  --p-confidence 0.7 \
  --p-read-orientation same 
#STEP 6: FILTER ARCHAEA, CHLOROPLAST, SINGLETONS
qiime taxa filter-table \
  --i-table table-dada2.qza \
  --i-taxonomy taxonomy.qza \
  --p-exclude Archaea \
  --p-mode contains \
  --o-filtered-table table-ddada2-noAr.qza 

#qiime taxa filter-table \
  --i-table table-ddada2-noAr.qza \
  --i-taxonomy taxonomy.qza \
  --p-exclude Eukaryota \
  --p-mode contains \
  --o-filtered-table table-ddada2-noArnoEu.qza 

#qiime feature-table filter-features \
  --i-table table-ddada2-noArnoEu.qza \
  --p-min-frequency 2 \
  --o-filtered-table table-clean.qza 
#STEP 11: RAREIFY TABLE
qiime diversity alpha-rarefaction \
  --i-table table-dada2.qza \
  --i-phylogeny rooted-tree-rep-seqs.qza \
  --p-max-depth 7000 \
  --m-metadata-file metadata_final.tsv \
  --o-visualization alpha-rarefaction.qzv
#STEP 12: CREATE TAXA BARPLOT
qiime taxa barplot \
  --i-table table-clean.qza \
  --i-taxonomy taxonomy.qza \
  --m-metadata-file metadata_final.tsv \
  --o-visualization taxa-bar-plots.qzv
#STEP 13: DIVERSITY ANALYSIS
qiime diversity core-metrics-phylogenetic \
  --i-phylogeny rooted-tree-rep-seqs.qza \
  --i-table table-clean.qza \
  --p-sampling-depth 1103 \
  --m-metadata-file metadata_final.tsv \
  --output-dir core-metrics-results
#ALPHA DIVERSITY
qiime diversity alpha-group-significance \
  --i-alpha-diversity core-metrics-results/faith_pd_vector.qza \
  --m-metadata-file metadata_final.tsv \
  --o-visualization core-metrics-results/faith-pd-group-significanceboth.qzv
#BETA DIVERSITY
qiime emperor plot \
  --i-pcoa core-metrics-results/bray_curtis_pcoa_results.qza \
  --m-metadata-file metadata_final.tsv \
  --o-visualization core-metrics-results/bray_curtis_pcoa_results.qzv
STEP 14: EXPORT FROM QIIME2 TO R
Based on this tutorial

First I need an unrooted tree

# Export tree
qiime tools export --input-path not-rooted-tree.qza \
  --output-path Phyloseq
# Export taxonomy
qiime tools export --input-path taxonomy.qza \
--output-path Phyloseq
# Export table
qiime tools export --input-path table-clean.qza \
    --output-path Phyloseq
The first line in our taxonomy file must be changes to #OTUID

sed 's/Feature ID/#OTUID/' Phyloseq/taxonomy.tsv | sed 's/Taxon/taxonomy/' | sed 's/Confidence/confidence/' > Phyloseq/biom-taxonomy.tsv
Add the Taxonomy data to the Biom file

biom add-metadata \
    -i Phyloseq/feature-table.biom \
    -o Phyloseq/table-with-taxonomyv2.biom \
    --observation-metadata-fp Phyloseq/biom-taxonomy.tsv \
    --sc-separated taxonomy 
Add the taxonomy data to your biom file

biom add-metadata \
    -i Phyloseq/feature-table.biom \
    -o Phyloseq/table-with-taxonomyv2.biom \
    --observation-metadata-fp Phyloseq/biom-taxonomy.tsv \
    --sc-separated taxonomy 
Now that we have the necessary files we will hop onto Phyloseq in R

# Move the PhyloSeq folder to my local computer aquesta comanda s'ha de fer desconnectat del servidor o enganxarà la carpeta a venus, no al teu ordinador
scp -r intern@161.116.67.159:~/data/data/microbiota_pau/sequences/Phyloseq  scp -r intern@161.116.67.159:~/data/data/microbiota_pau/sequences/Phyloseq ~/Desktop

# Add reference sequences for functional analisis, abans però haurem d obtenir en arxiu en format fasta

qiime tools export \
  --input-path rep-seqs-dada2.qza \
  --output-path dna-sequences.fasta

scp -r intern@161.116.67.159:~/data/data/microbiota_pau/sequences/dna-sequences.fasta ~/Desktop
STEP 15 : FAPROTAX for functional annotations
Download the pacakge 
http://www.loucalab.com/archive/FAPROTAX/lib/php/index.php?section=Download

Directory /Users/paubernado/Desktop/TFM Urchin's Microbiota/Phyloseq
# Convert biom table to tsv, because with biom didn't work
biom convert -i table-with-taxonomyv2.biom -o table-with-taxonomyv2.txt --to-tsv --header-key taxonomy

# Run command
python3	./collapse_table.py -i table-with-taxonomyv2.txt -g FAPROTAX.txt -f -o functional_otu_table.tsv -r report.txt --column_names_are_in last_comment_line  --keep_header_comments --non_numeric consolidate -v --row_names_are_in_column "taxonomy" --omit_columns 0 --normalize_collapsed columns_before_collapsing --group_leftovers_as 'other'
