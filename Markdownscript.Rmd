---
title: "Untitled"
output: html_document
date: "2025-08-24"
---

```{r setup, include=FALSE}
#source('http://bioconductor.org/biocLite.R')
#biocLite('phyloseq')
library("phyloseq")
#biocLite("biomformat")
library("biomformat")
#install.packages("ggplot2")
library("ggplot2")
#install.packages("ggpubr")
library("ggpubr")
#install.packages("RColorBrewer")
library("RColorBrewer")
#install.packages("vegan")
library("vegan")
#install.packages("grid")
library("grid")
#install.packages("rstatix")
library(rstatix)
#install.packages("magrittr")
library(magrittr)
library(dplyr)
library(plyr)
library(broom)
library('stringr')
#if (!requireNamespace("devtools", quietly = TRUE)){install.packages("devtools")}
#devtools::install_github("jbisanz/qiime2R")
library('qiime2R')
#devtools::install_github("microbiome/microbiome") # Install the package
library('decontam')
library(microbiome)
#devtools::install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
library(pairwiseAdonis)
#devtools::install_github("microsud/microbiomeutilities")
library(microbiomeutilities)
#install.packages("wesanderson")
library(wesanderson)
#install.packages("eulerr")
library(eulerr)
#install.packages("picante")
library(picante)
#if (!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("ANCOMBC")
library(ANCOMBC)
library(tidyr)
#install.packages("ggvenn")
library(ggvenn)
#install.packages("lmPerm")
library(lmPerm)
#install.packages("phytools")
library(phytools)
#install.packages("RVAideMemoire")
library(RVAideMemoire)


## we can also import the qza artifacts from qiime2 directly with qiime2R
#follow this : https://github.com/jbisanz/qiime2R

library(biomformat)
library(phyloseq)

# 1) Llegeix el BIOM HDF5
bm <- biomformat::read_biom("table-with-taxonomyv2.biom")

# 2) Construeix el phyloseq a partir del biom (usarà la columna 'taxonomy' si existeix)
ps <- phyloseq::import_biom(bm, parseFunction = parse_taxonomy_default)

# 3) Afegeix arbre i metadata
tree <- phyloseq::read_tree("tree.nwk")
meta <- phyloseq::import_qiime_sample_data("metadata_final.tsv")

phylo <- phyloseq::merge_phyloseq(ps, tree, meta)
#Add names to biom table and check phyloseq objects
colnames(tax_table(phylo))= c("Kingdom","Phylum","Class","Order","Family","Genus", "Species")
rank_names(phylo)

# Path to your exported FASTA file
fasta_path <- "dna-sequences.fasta"
rep_seqs <- Biostrings::readDNAStringSet(fasta_path)
# Add sequences to the phyloseq object
phylo <- phyloseq::merge_phyloseq(phylo, refseq(rep_seqs))

# Start to explore the data a bit 
#number of samples
nsamples(phylo)
# number of sequence variants
ntaxa(phylo)
#summary statistics of sampling depth
depths <- sample_sums(phylo)
summary(depths)
# We see that we have samples with a very low sequencing depth > we can remove the sample


otu_tab <- t(abundances(phylo))
p <- vegan::rarecurve(otu_tab, 
                      step = 50, label = FALSE, 
                      sample = min(rowSums(otu_tab), 
                                   col = "blue", cex = 0.6))
p


## Remove contaminants with decontam package
```{r}

sample_data(phylo)$is.neg <- sample_data(phylo)$Species.name %in% c(
  "Extraccion control",
  "PCR Negative control")

contamdf.prev <- isContaminant(phylo, method="prevalence", neg="is.neg", threshold =0.2)
table(contamdf.prev$contaminant)

# Make phyloseq object of presence-absence in negative controls and true samples
ps.pa <- transform_sample_counts(phylo, function(abund) 1*(abund>0))
# defineix els labels dels negatius
neg_labels <- c("Extraccion control", "PCR Negative control")

# NEGATIUS (només els controls)
ps.pa.neg <- prune_samples(sample_data(phylo)$Species.name %in% neg_labels, phylo)

# POSITIUS (la resta de mostres)
ps.pa.pos <- prune_samples(!(sample_data(phylo)$Species.name %in% neg_labels), phylo)
# Make data.frame of prevalence in positive and negative samples
df.pa <- data.frame(pa.pos=taxa_sums(ps.pa.pos), pa.neg=taxa_sums(ps.pa.neg),
                      contaminant=contamdf.prev$contaminant)
ggplot(data=df.pa, aes(x=pa.neg, y=pa.pos, color=contaminant)) + geom_point() +
  xlab("Prevalence (Negative Controls)") + ylab("Prevalence (True Samples)")

# Extract contaminants
phylo <- prune_taxa(!contamdf.prev$contaminant, phylo)

## Taxa bar plots
microbiome::summarize_phyloseq(phylo)

otu_tab <- microbiome::abundances(phylo)
otu_tab[1:5,1:5]

tax_tab <- phyloseq::tax_table(phylo)
tax_tab[1:5,1:5]

### Clean taxonomy table 
## Taxonomy ranks with proper names 
tax_table_clean <- tax_table(phylo)
# Remove prefixes d__, p__, etc.
tax_table_clean <- apply(tax_table_clean, 2, function(x) gsub("^[a-z]__", "", x))
# Assign the cleaned table back to the phyloseq object
tax_table(phylo) <- tax_table_clean
phyloseq::tax_table(phylo)[1:3,1:3]

# ASV names from dada are long - change to ASVX... 
taxa_names(phylo)[1:5]
taxa_names(phylo) <- paste0("ASV", seq(ntaxa(phylo)))

# Remove special characters
tax_table(phylo)[,colnames(tax_table(phylo))] <- gsub(tax_table(phylo)[,colnames(tax_table(phylo))],pattern="=*",replacement="")

# remove asterisk
tax_table(phylo)[,colnames(tax_table(phylo))] <- gsub(tax_table(phylo)[,colnames(tax_table(phylo))],pattern="[*]",replacement="") # notice here the square brackets. These are required when special characters such as * and ~ below are used as they have functional role in R base programming. 

# remove ~
tax_table(phylo)[,colnames(tax_table(phylo))] <- gsub(tax_table(phylo)[,colnames(tax_table(phylo))],pattern="[~]",replacement="")

# Update column name Domain instead of Kingdom (for core microbiome)
tax_df <- as.data.frame(tax_table(phylo))  # Extract the taxonomy table
colnames(tax_df)[colnames(tax_df) == "Kingdom"] <- "Domain"  # Rename Kingdom to Domain
tax_table(phylo) <- as.matrix(tax_df)  # Update the phyloseq object

### All samples at Phylum level 

# Subset only the samples of Arbacia and Paracentrotus

# Què volem conservar
keep_species <- c("Arbacia lixula", "Paracentrotus lividus", "Water sample")

# 1) Subset de mostres (exclou negatius/extracció; inclou water sample)
phylo2 <- subset_samples(
  phylo,
  Species.name %in% keep_species &
    (is.na(is.neg) | is.neg == FALSE)
)

# Subset samples with total reads > 5000
phylo2 <- prune_samples(sample_sums(phylo2) > 5000, phylo2)

phylo.pruned <- prune_taxa(taxa_sums(phylo2) >0, phylo2)

# merge all taxa that are detected rare

phylum.data <- aggregate_rare(phylo.pruned, level="Phylum", detection = 0.1, prevalence = 0.5)


### Relative abundances
phylum.data.rel<- microbiome::transform(phylum.data, "compositional")

## 1) Long format amb metadata i taxonomia
df <- psmelt(phylum.data.rel)   # ha de tenir: Sample, Abundance, Phylum, Species.name, etc.

## 2) Abrevia les etiquetes de mostra al primer "_"
df$Sample_short <- sub("_.*", "", df$Sample)

## 3) Ordena les mostres si tens una columna 'orden' a la metadata
if ("orden" %in% colnames(df)) {
  df <- df %>% arrange(orden)
  df$Sample_short <- factor(df$Sample_short, levels = df %>% distinct(Sample_short, orden) %>% pull(Sample_short))
} else {
  message("⚠️  'orden' no és a la metadata d'aquest objecte; es manté l'ordre original.")
}

## 4) Facet per espècie i barplot apilat per Phylum
plot.phylum <- ggplot(df, aes(x = Sample_short, y = Abundance, fill = Phylum)) +
  geom_col() +
  facet_wrap(~ Species.name, scales = "free_x", nrow = 1) +
  labs(x = "Sample (prefix)", y = "Relative abundance", fill = "Phylum") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.ticks.x = element_line())

## 5) Paleta personalitzada (si la tens)
if (exists("custom_palette2")) {
  plot.phylum <- plot.phylum + scale_fill_manual(values = custom_palette2, name = "Phylum")
}

plot.phylum
# Count phyla
n_phyla <- length(unique(tax_table(phylum.data)[, "Phylum"]))
# Generate a long palette
custom_palette2 <- colorRampPalette(brewer.pal(15, "Paired"))(n_phyla)

### All samples at Family level 
family.data <- aggregate_rare(phylo.pruned, level="Family", detection = 0.1, prevalence = 0.5)

### All samples at Genus level 
genus.data<-aggregate_rare(phylo.pruned, level="Genus", detection = 0.1, prevalence = 0.5)

##RAREFACTION, REMOVING OUTLIERS

# Rarefy 5000reads 
set.seed(9242)  # This will help in reproducing the filtering and nomalisation.
phylo.rare <- rarefy_even_depth(phylo2, sample.size = 5000)
```


```{r setup, include=FALSE}
# Alpha diversity indices 
phylo.adiv <- alpha(phylo.rare, index = "all")
phylo.meta<- meta(phylo.rare)  

phylo.rare.asvtab <- as.data.frame(phylo.rare@otu_table)

phylo.rare.tree <- phylo.rare@phy_tree

phylo.rare.pd <- pd(t(phylo.rare.asvtab), phylo.rare.tree, include.root=F)

phylo.adiv$Phylogenetic_Diversity <- phylo.rare.pd$PD

Alpha.diversity<- rbind(
  data.frame(
    sample.id = phylo.meta$X.SampleID,
    Species.name = phylo.meta$Species.name,
    Location = phylo.meta$Location,
    Seasonality= phylo.meta$Seasonality..sampling.effort.order.,
    Impact=phylo.meta$Anthropic.influence,
    observed = phylo.adiv$observed,
    shannon = phylo.adiv$diversity_shannon,
    phylogenetic_diversity = phylo.adiv$Phylogenetic_Diversity
  ))
```
ARBACIA ALPHA DIVERSITY

```{r setup, include=FALSE}
library(dplyr)
library(emmeans)
library(car)       # Anova(type = 3)
Alpha.diversity <- Alpha.diversity %>%
  mutate(
    Impact = dplyr::recode(as.character(Impact),
      "Contaminated"      = "Higher-impact",
      "Non Contaminated"  = "Lower-Impact",
      .default = as.character(Impact),
      .missing = as.character(Impact)
    ),
    Seasonality = dplyr::recode(as.character(Seasonality),
      "First"  = "Spring",
      "Second" = "Autumn",
      "Third"  = "Winter",
      .default = as.character(Seasonality),
      .missing = as.character(Seasonality)
    )
  ) %>%
  mutate(
    Impact      = factor(Impact,      levels = c("Lower-Impact","Higher-impact")),
    Seasonality = factor(Seasonality, levels = c("Spring","Autumn","Winter"))
  ) %>%
  droplevels()
# Contrastos de suma per a Type III
options(contrasts = c("contr.sum","contr.poly"))


## Subset Arbacia
df_A <- Alpha.diversity %>%
  filter(Species.name == "Arbacia lixula") %>%
  droplevels()

### NESTED MODEL Seasonality * Location/Impact

## --- SHANNON ---
m_A_sha <- lm(shannon ~ Seasonality * Location/Impact, data = df_A)
Anova(m_A_sha, type = 3)

# Pairwise Seasonality dins de cada Location (respecta la interacció)
emm_A_season_by_loc_sha <- emmeans(m_A_sha, ~ Seasonality | Location)
pairs(emm_A_season_by_loc_sha, adjust = "tukey")

# Pairwise Impact dins de cada Location i Seasonality (respecta nesting + interacció)
emm_A_imp_by_loc_seas_sha <- emmeans(m_A_sha, ~ Impact | Location:Seasonality)
pairs(emm_A_imp_by_loc_seas_sha, adjust = "BH")  

## --- OBSERVED RICHNESS ---
m_A_obs <- lm(observed ~ Seasonality * Location/Impact, data = df_A)
Anova(m_A_obs, type = 3)

emm_A_season_by_loc_obs <- emmeans(m_A_obs, ~ Seasonality | Location)
pairs(emm_A_season_by_loc_obs, adjust = "tukey")

emm_A_imp_by_loc_seas_obs <- emmeans(m_A_obs, ~ Impact | Location:Seasonality)
pairs(emm_A_imp_by_loc_seas_obs, adjust = "BH")

## --- FAITH’S PHYLOGENETIC DIVERSITY (PD) ---
m_A_pd <- lm(phylogenetic_diversity ~ Seasonality * Location/Impact, data = df_A)
Anova(m_A_pd, type = 3)

emm_A_season_by_loc_pd <- emmeans(m_A_pd, ~ Seasonality | Location)
pairs(emm_A_season_by_loc_pd, adjust = "tukey")

emm_A_imp_by_loc_seas_pd <- emmeans(m_A_pd, ~ Impact | Location:Seasonality)
pairs(emm_A_imp_by_loc_seas_pd, adjust = "BH")

# Paleta anterior (Spring verd, Autumn taronja, Winter blau)
season_pal <- c(
  "Spring" = "#4DAF4A",  # verd fresc
  "Autumn" = "#E69F00",  # taronja suau
  "Winter" = "#0072B2"   # blau oceànic
)

# Filtrar només A. lixula i preparar dades
df_A <- df_A %>%
  filter(Species.name == "Arbacia lixula") %>%
  mutate(
    Block = interaction(Location, Impact, sep = " — ", drop = TRUE),
    Seasonality = factor(Seasonality, levels = c("Spring", "Autumn", "Winter")),
    Impact      = factor(Impact, levels = c("Lower-Impact", "Higher-impact"))
  )

# Funció per crear boxplots
make_box <- function(yvar, ylab, title_expr) {
  ggboxplot(
    df_A,
    x = "Seasonality",
    y = yvar,
    color = "Seasonality",
    palette = season_pal,   # << colors anteriors
    add = "jitter",
    facet.by = "Block",
    nrow = 1,
    outlier.shape = NA
  ) +
    labs(x = NULL, y = ylab, title = title_expr) +
    theme(
      strip.text = element_text(face = "bold"),
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank()
    )
}

# Tres gràfics amb *A. lixula* en cursiva
p_obs  <- make_box("observed", "Observed richness",
                   expression(italic("A. lixula") ~ " — Observed richness across seasons by block"))
p_shan <- make_box("shannon", "Shannon diversity (H')",
                   expression(italic("A. lixula") ~ " — Shannon diversity across seasons by block"))
p_pd   <- make_box("phylogenetic_diversity", "Faith's phylogenetic diversity",
                   expression(italic("A. lixula") ~ " — Phylogenetic diversity across seasons by block"))

# Composició final amb llegenda comuna
ggarrange(p_obs, p_shan, p_pd, ncol = 1, nrow = 3, common.legend = TRUE, legend = "right")
```

BETA DIVERSITY ARBACIA
```{r setup, include=FALSE}
## ============ 1) SUBSET + META CLEAN  ============
# Filtra Arbacia (sense mostres d'aigua, si escau)
psA <- subset_samples(phylo.rare, Species.name %in% c("Arbacia lixula","A. lixula"))
psA <- prune_samples(sample_names(psA), psA)  # neteja extra

# Reetiqueta factors a sample_data
metaA <- data.frame(sample_data(psA)) %>%
  mutate(
    Impact = dplyr::recode(as.character(Anthropic.influence),
                           "Non Contaminated" = "Lower-impact",
                           "Contaminated"     = "Higher-impact",
                           .default = NA_character_),
    Impact = factor(Impact, levels = c("Lower-impact","Higher-impact")),

    Seasonality = dplyr::recode(as.character(`Seasonality..sampling.effort.order.`),
                                "First"  = "Spring",
                                "Second" = "Autumn",
                                "Third"  = "Winter",
                                .default = NA_character_),
    Seasonality = factor(Seasonality, levels = c("Spring","Autumn","Winter")),

    Location = factor(Location)
  )

## ============ 2) RELATIVE ABUNDANCE  ============
psA.rel <- microbiome::transform(psA, "compositional")

## ============ 3) ORDINATIONS (PCoA)  ============
# Weighted UniFrac
ordA_w <- ordinate(psA.rel, method = "PCoA", distance = "wunifrac")
# Unweighted UniFrac
ordA_u <- ordinate(psA.rel, method = "PCoA", distance = "unifrac")

# Barplots d’eigenvalues
par(mfrow=c(1,2))
barplot(ordA_w$values$Eigenvalues[1:10], main="Weighted UniFrac eig.")
barplot(ordA_u$values$Eigenvalues[1:10], main="Unweighted UniFrac eig.")
par(mfrow=c(1,1))

## ============ 4) PLOTS (colors i shapes informatius) ============
# Weighted: color = Seasonality, shape = Location
p_w <- plot_ordination(psA.rel, ordA_w, color = "Seasonality", shape = "Location") +
  ggtitle("PCoA — Weighted UniFrac (Arbacia)") +
  geom_point(size = 3, alpha = 0.9) +
  theme_classic()

# Unweighted: color = Impact, shape = Location
p_u <- plot_ordination(psA.rel, ordA_u, color = "Impact", shape = "Location") +
  ggtitle("PCoA — Unweighted UniFrac (Arbacia)") +
  geom_point(size = 3, alpha = 0.9) +
  theme_classic()

print(p_w); print(p_u)

## ============ 5) DISTANCE MATRICES ============
distA_w <- phyloseq::distance(psA.rel, method = "wunifrac")
distA_u <- phyloseq::distance(psA.rel, method = "unifrac")


## ============ 7) PERMANOVA (Nested) ============
set.seed(123)
ctrl_loc <- how(nperm = 999, blocks = metaA$Location)  # constrain permutations within Location
perm_w_nested <- adonis2(
  distA_w ~ Seasonality *  Location/Impact,
  data = metaA,
  permutations = ctrl_loc,
  by = "terms"
)
print(perm_w_nested)

## 1) Seasonality within Location (permutations blocked within Location)
pw_w_season_given_loc <- pairwise.adonis2(
  distA_w ~ Seasonality,
  data   = metaA,
  strata = "Location",
  p.adjust.m = "BH",
  nperm = 999
)

## 2) Impact within Location (Impact is nested in Location → test within Location)
pw_w_impact_given_loc <- pairwise.adonis2(
  distA_w ~ Impact,
  data   = metaA,
  strata = "Location",
  p.adjust.m = "BH",
  nperm = 999
)


## 3) Impact dins de cada combinació Seasonality × Location
## (subconjunts per cada cel·la de Seasonality × Location; no cal 'strata' perquè Location queda fixat)

library(pairwiseAdonis)

# Clau de subconjunts (Seasonality × Location)
grp <- with(metaA, interaction(Seasonality, Location, drop = TRUE))

pw_w_impact_given_season_loc <- lapply(levels(grp), function(g) {
  idx <- which(grp == g)

  # Si hi ha < 2 nivells d'Impact en el subconjunt, saltem
  if (length(unique(metaA$Impact[idx])) < 2L) {
    return(sprintf("Omet: %s (menys de 2 nivells d'Impact)", g))
  }

  # Subdistància coherent amb el subconjunt
  sub_dist <- as.dist(as.matrix(distA_w)[idx, idx])

  # Subdata
  sub_data <- metaA[idx, , drop = FALSE]

  # Pairwise dins de la cel·la Seasonality × Location
  pairwise.adonis2(
    sub_dist ~ Impact,
    data       = sub_data,
    p.adjust.m = "BH",
    nperm      = 999
  )
})

names(pw_w_impact_given_season_loc) <- levels(grp)

pw_w_impact_given_season_loc


#GRÀFIC WEIGHTED
# Paquets
library(phyloseq)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggnewscale)

## 0) Dades de partida
ps_src <- if (exists("phylo.rare")) phylo.rare else phylo

# Filtra només Arbacia (accepta "Arbacia lixula" o "A. lixula")
psA <- subset_samples(ps_src, Species.name %in% c("Arbacia lixula", "A. lixula"))
psA <- prune_samples(sample_sums(psA) > 0, psA)
psA <- prune_taxa(taxa_sums(psA) > 0, psA)

# Assegura Seasonality i Impact a sample_data
sdA <- data.frame(sample_data(psA))

# Seasonality: si cal, deriva de 'Seasonality..sampling.effort.order.' → Spring/Autumn/Winter
if (!"Seasonality" %in% names(sdA) && "Seasonality..sampling.effort.order." %in% names(sdA)) {
  sdA$Seasonality <- dplyr::recode(
    as.character(sdA$Seasonality..sampling.effort.order.),
    "First" = "Spring", "Second" = "Autumn", "Third" = "Winter",
    .default = NA_character_
  )
}
sdA$Seasonality <- factor(sdA$Seasonality, levels = c("Winter","Spring","Autumn"))

# Impact: si cal, deriva d'Anthropic.influence → Lower-impact / Higher-impact
if (!"Impact" %in% names(sdA) && "Anthropic.influence" %in% names(sdA)) {
  sdA$Impact <- dplyr::recode(
    as.character(sdA$Anthropic.influence),
    "Non Contaminated" = "Lower-impact",
    "Contaminated"     = "Higher-impact",
    .default = NA_character_
  )
}
sdA$Impact <- factor(sdA$Impact, levels = c("Lower-impact","Higher-impact"))

# Escriu a l'objecte
sample_data(psA)$Seasonality <- sdA$Seasonality
sample_data(psA)$Impact      <- sdA$Impact

# Paleta per Season (si no existeix)
if (!exists("season_pal")) {
  season_pal <- c(Winter = "#4C78A8", Spring = "#72B7B2", Autumn = "#F58518")
}

## 1) (opcional) Transformació a relatiu (per visualitzar)
psA.rel <- microbiome::transform(psA, "compositional")

## 2) PCoA Weighted UniFrac
ordA_w <- ordinate(psA.rel, method = "PCoA", distance = "wunifrac")

# Percentatge explicat per eixos
rel <- ordA_w$values$Relative_eig
if (is.null(rel)) rel <- ordA_w$values$Eigenvalues / sum(ordA_w$values$Eigenvalues)
ax1 <- round(100 * rel[1], 1)
ax2 <- round(100 * rel[2], 1)

## 3) Data per a ggplot i capes
pdat <- plot_ordination(psA.rel, ordA_w, type = "samples")$data
pdat$Seasonality <- factor(pdat$Seasonality, levels = c("Winter","Spring","Autumn"))
pdat$Impact      <- factor(pdat$Impact, levels = c("Lower-impact","Higher-impact"))
pdat_hi <- dplyr::filter(pdat, Impact == "Higher-impact")

# Shapes “omplibles” per Location (21–25). Garanteix longitud suficient.
loc_levels <- levels(sample_data(psA.rel)$Location)
if (is.null(loc_levels)) loc_levels <- unique(pdat$Location)
base_shapes <- c(21, 24, 22, 25, 23)  # tots omplibles
shape_vals <- setNames(base_shapes[seq_len(min(length(base_shapes), length(loc_levels)))], loc_levels)

## 4) Plot: color = Season, shape = Location, ple (mateix color) només Higher-impact + llegenda dummy d'Impact
p_pcoa_w <- ggplot(pdat, aes(Axis.1, Axis.2)) +
  # El·lipses 95% per Season
  stat_ellipse(aes(color = Seasonality, group = Seasonality),
               type = "norm", level = 0.95, linewidth = 0.8) +
  # Capa base: punts buits (contorn = Season), shape = Location
  geom_point(aes(color = Seasonality, shape = Location),
             size = 3, stroke = 0.9, fill = NA, alpha = 0.95) +
  # Overlay: mateix shape/contorn però ple del mateix color per Higher-impact
  geom_point(data = pdat_hi,
             aes(color = Seasonality, fill = Seasonality, shape = Location),
             size = 3, stroke = 0.9, alpha = 0.95) +
  scale_color_manual(values = season_pal, breaks = c("Winter","Spring","Autumn"), name = "Season") +
  scale_fill_manual(values = season_pal, guide = "none") +
  scale_shape_manual(values = shape_vals, name = "Location") +
  labs(
    title = expression(italic("Arbacia lixula") ~ " — PCoA (Weighted UniFrac)"),
    x = paste0("PCoA1 (", ax1, "%)"),
    y = paste0("PCoA2 (", ax2, "%)")
  ) +
  theme_classic(base_size = 12) +
  theme(plot.title = element_text(face = "bold"))

# Llegenda dummy d'Impact (buit vs ple) sense subtítol extra
p_pcoa_w <- p_pcoa_w +
  ggnewscale::new_scale_fill() +
  geom_point(
    data = pdat,
    aes(fill = Impact),    # només per a la llegenda d'Impact
    shape = 21, color = "black",
    size = 3, alpha = 0,   # invisible, però crea la llegenda
    inherit.aes = TRUE
  ) +
  scale_fill_manual(
    values = c("Lower-impact" = "white", "Higher-impact" = "black"),
    breaks = c("Lower-impact","Higher-impact"),
    name   = "Impact"
  ) +
  guides(fill = guide_legend(override.aes = list(alpha = 1, shape = 21, size = 3, color = "black")))

# Mostra el plot
p_pcoa_w






##UNWEIGHTED

set.seed(123)
ctrl_loc <- how(nperm = 999, blocks = metaA$Location)  # constrain permutations within Location
perm_u_nested <- adonis2(
  distA_u  ~ Seasonality * Location/Impact,
  data = metaA,
  permutations = ctrl_loc,
  by = "terms"
)
print(perm_u_nested)

## 1) Seasonality within Location (permutations blocked within Location)
pw_u_season_given_loc <- pairwise.adonis2(
  distA_u ~ Seasonality,
  data   = metaA,
  strata = "Location",
  p.adjust.m = "BH",
  nperm = 999
)

## 2) Impact within Location (Impact is nested in Location → test within Location)
pw_u_impact_given_loc <- pairwise.adonis2(
  distA_u ~ Impact,
  data   = metaA,
  strata = "Location",
  p.adjust.m = "BH",
  nperm = 999
)


#GRÀFIC UNWEIGHTED
# Paquets
library(phyloseq)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggnewscale)

## 0) Punt de partida (assumeix que ja tens psA i/o psA.rel creats)
ps_src <- if (exists("phylo.rare")) phylo.rare else phylo
psA <- subset_samples(ps_src, Species.name %in% c("Arbacia lixula", "A. lixula"))
psA <- prune_samples(sample_sums(psA) > 0, psA)
psA <- prune_taxa(taxa_sums(psA) > 0, psA)

# (opcional) transformació; per unweighted no és necessari, però mantinc consistència amb el teu flux
psA.rel <- if (exists("psA.rel")) psA.rel else microbiome::transform(psA, "compositional")

# Assegura Seasonality i Impact
sdA <- data.frame(sample_data(psA.rel))
if (!"Seasonality" %in% names(sdA) && "Seasonality..sampling.effort.order." %in% names(sdA)) {
  sdA$Seasonality <- dplyr::recode(
    as.character(sdA$Seasonality..sampling.effort.order.),
    "First"="Spring","Second"="Autumn","Third"="Winter", .default = NA_character_
  )
}
sdA$Seasonality <- factor(sdA$Seasonality, levels = c("Winter","Spring","Autumn"))
if (!"Impact" %in% names(sdA) && "Anthropic.influence" %in% names(sdA)) {
  sdA$Impact <- dplyr::recode(
    as.character(sdA$Anthropic.influence),
    "Non Contaminated" = "Lower-impact",
    "Contaminated"     = "Higher-impact",
    .default = NA_character_
  )
}
sdA$Impact <- factor(sdA$Impact, levels = c("Lower-impact","Higher-impact"))
sample_data(psA.rel)$Seasonality <- sdA$Seasonality
sample_data(psA.rel)$Impact      <- sdA$Impact

# Paleta
if (!exists("season_pal")) {
  season_pal <- c(Winter = "#4C78A8", Spring = "#72B7B2", Autumn = "#F58518")
}

## 1) PCoA Unweighted UniFrac
ordA_u <- ordinate(psA.rel, method = "PCoA", distance = "unifrac")

rel_u <- ordA_u$values$Relative_eig
if (is.null(rel_u)) rel_u <- ordA_u$values$Eigenvalues / sum(ordA_u$values$Eigenvalues)
ax1u <- round(100 * rel_u[1], 1)
ax2u <- round(100 * rel_u[2], 1)

## 2) Dataframe per a ggplot
pdat <- plot_ordination(psA.rel, ordA_u, type = "samples")$data
pdat$Seasonality <- factor(pdat$Seasonality, levels = c("Winter","Spring","Autumn"))
pdat$Impact      <- factor(pdat$Impact, levels = c("Lower-impact","Higher-impact"))
pdat_hi <- dplyr::filter(pdat, Impact == "Higher-impact")

# Shapes per Location (omplibles)
loc_levels <- levels(sample_data(psA.rel)$Location)
if (is.null(loc_levels)) loc_levels <- unique(pdat$Location)
base_shapes <- c(21, 24, 22, 25, 23)
shape_vals <- setNames(base_shapes[seq_len(min(length(base_shapes), length(loc_levels)))], loc_levels)

## 3) Plot Unweighted amb llegenda dummy d'Impact
p_pcoa_u <- ggplot(pdat, aes(Axis.1, Axis.2)) +
  stat_ellipse(aes(color = Seasonality, group = Seasonality),
               type = "norm", level = 0.95, linewidth = 0.8) +
  geom_point(aes(color = Seasonality, shape = Location),
             size = 3, stroke = 0.9, fill = NA, alpha = 0.95) +
  geom_point(data = pdat_hi,
             aes(color = Seasonality, fill = Seasonality, shape = Location),
             size = 3, stroke = 0.9, alpha = 0.95) +
  scale_color_manual(values = season_pal, breaks = c("Winter","Spring","Autumn"), name = "Season") +
  scale_fill_manual(values = season_pal, guide = "none") +
  scale_shape_manual(values = shape_vals, name = "Location") +
  labs(
    title = expression(italic("Arbacia lixula") ~ " — PCoA (Unweighted UniFrac)"),
    x = paste0("PCoA1 (", ax1u, "%)"),
    y = paste0("PCoA2 (", ax2u, "%)")
  ) +
  theme_classic(base_size = 12) +
  theme(plot.title = element_text(face = "bold"))

# Llegenda dummy Impact (buit vs ple)
p_pcoa_u <- p_pcoa_u +
  ggnewscale::new_scale_fill() +
  geom_point(
    data = pdat,
    aes(fill = Impact),
    shape = 21, color = "black",
    size = 3, alpha = 0,    # invisible però crea llegenda
    inherit.aes = TRUE
  ) +
  scale_fill_manual(
    values = c("Lower-impact" = "white", "Higher-impact" = "black"),
    breaks = c("Lower-impact","Higher-impact"),
    name   = "Impact"
  ) +
  guides(fill = guide_legend(override.aes = list(alpha = 1, shape = 21, size = 3, color = "black")))

p_pcoa_u
```


```{r setup, include=FALSE}
# Anova(type = 3)
Alpha.diversity <- Alpha.diversity %>%
  mutate(
    Impact = dplyr::recode(as.character(Impact),
      "Contaminated"      = "Higher-impact",
      "Non Contaminated"  = "Lower-Impact",
      .default = as.character(Impact),
      .missing = as.character(Impact)
    ),
    Seasonality = dplyr::recode(as.character(Seasonality),
      "First"  = "Spring",
      "Second" = "Autumn",
      "Third"  = "Winter",
      .default = as.character(Seasonality),
      .missing = as.character(Seasonality)
    )
  ) %>%
  mutate(
    Impact      = factor(Impact,      levels = c("Lower-Impact","Higher-impact")),
    Seasonality = factor(Seasonality, levels = c("Spring","Autumn","Winter"))
  ) %>%
  droplevels()
# Contrastos de suma per a Type III
options(contrasts = c("contr.sum","contr.poly"))


## Subset Paracentrotus
df_P <- Alpha.diversity %>%
  filter(Species.name == "Paracentrotus lividus") %>%
  droplevels()

### NESTED MODEL Seasonality * Location/Impact

## --- SHANNON ---
m_P_sha <- lm(shannon ~ Seasonality * Location/Impact, data = df_P)
Anova(m_P_sha, type = 3)

## --- OBSERVED RICHNESS ---
m_P_obs <- lm(observed ~ Seasonality * Location/Impact, data = df_P)
Anova(m_P_obs, type = 3)

emm_P_imp_by_loc_seas_obs <- emmeans(m_P_obs, ~ Impact | Location:Seasonality)
pairs(emm_P_imp_by_loc_seas_obs, adjust = "BH")

## --- FAITH’S PHYLOGENETIC DIVERSITY (PD) ---
m_P_pd <- lm(phylogenetic_diversity ~ Seasonality * Location/Impact, data = df_P)
Anova(m_P_pd, type = 3)

emm_pd_seas <- emmeans(m_P_pd, ~ Seasonality)
pairs(emm_pd_seas, adjust = "BH")

emm_P_imp_by_loc_seas_pd <- emmeans(m_P_pd, ~ Impact | Location:Seasonality)
pairs(emm_P_imp_by_loc_seas_pd, adjust = "BH")

library(ggpubr)
library(dplyr)

# Paleta anterior (Spring verd, Autumn taronja, Winter blau)
season_pal <- c(
  "Spring" = "#4DAF4A",  # verd fresc
  "Autumn" = "#E69F00",  # taronja suau
  "Winter" = "#0072B2"   # blau oceànic
)

# Preparar dades (estandarditza Impact i crea Block)
df_P2 <- df_P %>%
  # Si df_P ja és només Paracentrotus, no cal filtrar; si no, descomenta:
  # filter(grepl("Paracentrotus", Species.name, ignore.case = TRUE)) %>%
  mutate(
    Impact = ifelse(Impact %in% c("Lower-Impact","Lower-impact","Non Contaminated"),
                    "Lower-impact", "Higher-impact"),
    Impact = factor(Impact, levels = c("Lower-impact","Higher-impact")),
    Seasonality = factor(Seasonality, levels = c("Spring","Autumn","Winter")),
    Block = interaction(Location, Impact, sep = " — ", drop = TRUE)
  ) %>%
  droplevels()

df_P2$Block <- forcats::fct_relevel(
  df_P2$Block,
  "Blanes — Lower-impact",
  "Blanes — Higher-impact",
  "Escala — Lower-impact",
  "Escala — Higher-impact"
)

# Funció per fer el boxplot
make_box_P <- function(y_var, y_label, title_expr) {
  ggboxplot(
    df_P2,
    x = "Seasonality", y = y_var,
    color = "Seasonality",
    palette = season_pal,
    add = "jitter",
    outlier.shape = NA,
    facet.by = "Block",
    nrow = 1
  ) +
    labs(x = NULL, y = y_label, title = title_expr) +
    theme_bw(base_size = 12) +
    theme(
      strip.text = element_text(face = "bold"),
      legend.title = element_blank(),
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      panel.grid.minor = element_blank()
    )
}

# Tres panells amb *P. lividus* en cursiva
p_obs_P  <- make_box_P("observed", "Observed richness",
                       expression(italic("P. lividus") ~ " — Observed richness across seasons by block"))
p_shan_P <- make_box_P("shannon", "Shannon diversity (H')",
                       expression(italic("P. lividus") ~ " — Shannon diversity across seasons by block"))
p_pd_P   <- make_box_P("phylogenetic_diversity", "Faith's phylogenetic diversity",
                       expression(italic("P. lividus") ~ " — Phylogenetic diversity across seasons by block"))

# Composició final amb llegenda comuna
ggarrange(p_obs_P, p_shan_P, p_pd_P,
          ncol = 1, nrow = 3,
          common.legend = TRUE, legend = "right")
```


```{r setup, include=FALSE}
## ============ 1) SUBSET + META CLEAN  ============
# Filtra Arbacia (sense mostres d'aigua, si escau)
psP <- subset_samples(phylo.rare, Species.name %in% c("Paracentrotus lividus","P. lividus"))
psP <- prune_samples(sample_names(psP), psP)  # neteja extra

# Reetiqueta factors a sample_data
metaP <- data.frame(sample_data(psP)) %>%
  mutate(
    Impact = dplyr::recode(as.character(Anthropic.influence),
                           "Non Contaminated" = "Lower-impact",
                           "Contaminated"     = "Higher-impact",
                           .default = NA_character_),
    Impact = factor(Impact, levels = c("Lower-impact","Higher-impact")),

    Seasonality = dplyr::recode(as.character(`Seasonality..sampling.effort.order.`),
                                "First"  = "Spring",
                                "Second" = "Autumn",
                                "Third"  = "Winter",
                                .default = NA_character_),
    Seasonality = factor(Seasonality, levels = c("Spring","Autumn","Winter")),

    Location = factor(Location)
  )

## ============ 2) RELATIVE ABUNDANCE  ============
psP.rel <- microbiome::transform(psP, "compositional")

## ============ 3) ORDINATIONS (PCoA)  ============
# Weighted UniFrac
ordP_w <- ordinate(psP.rel, method = "PCoA", distance = "wunifrac")
# Unweighted UniFrac
ordP_u <- ordinate(psP.rel, method = "PCoA", distance = "unifrac")

# Barplots d’eigenvalues
par(mfrow=c(1,2))
barplot(ordA_w$values$Eigenvalues[1:10], main="Weighted UniFrac eig.")
barplot(ordA_u$values$Eigenvalues[1:10], main="Unweighted UniFrac eig.")
par(mfrow=c(1,1))

## ============ 4) PLOTS (colors i shapes informatius) ============
# Weighted: color = Seasonality, shape = Location
p_w <- plot_ordination(psA.rel, ordA_w, color = "Seasonality", shape = "Location") +
  ggtitle("PCoA — Weighted UniFrac (Arbacia)") +
  geom_point(size = 3, alpha = 0.9) +
  theme_classic()

# Unweighted: color = Impact, shape = Location
p_u <- plot_ordination(psA.rel, ordA_u, color = "Impact", shape = "Location") +
  ggtitle("PCoA — Unweighted UniFrac (Arbacia)") +
  geom_point(size = 3, alpha = 0.9) +
  theme_classic()

print(p_w); print(p_u)

## ============ 5) DISTANCE MATRICES ============
distP_w <- phyloseq::distance(psP.rel, method = "wunifrac")
distP_u <- phyloseq::distance(psP.rel, method = "unifrac")

##WEIGHTED

set.seed(123)
ctrl_loc <- how(nperm = 999, blocks = metaP$Location)  # constrain permutations within Location
perm_w_nested <- adonis2(
  distP_w ~ Seasonality * Location/Impact,
  data = metaP,
  permutations = ctrl_loc,
  by = "terms"
)
print(perm_w_nested)

## 1) Seasonality within Location (permutations blocked within Location)
pw_w_season_given_loc <- pairwise.adonis2(
  distP_w ~ Seasonality,
  data   = metaP,
  strata = "Location",
  p.adjust.m = "BH",
  nperm = 999
)

## 2) Impact within Location (Impact is nested in Location → test within Location)
pw_w_impact_given_loc <- pairwise.adonis2(
  distP_w ~ Impact,
  data   = metaP,
  strata = "Location",
  p.adjust.m = "BH",
  nperm = 999
)


## 3) Impact dins de cada combinació Seasonality × Location
## (subconjunts per cada cel·la de Seasonality × Location; no cal 'strata' perquè Location queda fixat)

library(pairwiseAdonis)

# Clau de subconjunts (Seasonality × Location)
grp <- with(metaP, interaction(Seasonality, Location, drop = TRUE))

pw_w_impact_given_season_loc <- lapply(levels(grp), function(g) {
  idx <- which(grp == g)

  # Si hi ha < 2 nivells d'Impact en el subconjunt, saltem
  if (length(unique(metaP$Impact[idx])) < 2L) {
    return(sprintf("Omet: %s (menys de 2 nivells d'Impact)", g))
  }

  # Subdistància coherent amb el subconjunt
  sub_dist <- as.dist(as.matrix(distP_w)[idx, idx])

  # Subdata
  sub_data <- metaP[idx, , drop = FALSE]

  # Pairwise dins de la cel·la Seasonality × Location
  pairwise.adonis2(
    sub_dist ~ Impact,
    data       = sub_data,
    p.adjust.m = "BH",
    nperm      = 999
  )
})

names(pw_w_impact_given_season_loc) <- levels(grp)

pw_w_impact_given_season_loc

##UNWEIGHTED

set.seed(123)
ctrl_loc <- how(nperm = 999, blocks = metaP$Location)  # constrain permutations within Location
perm_u_nested <- adonis2(
  distP_u  ~ Seasonality * Location/Impact,
  data = metaP,
  permutations = ctrl_loc,
  by = "terms"
)
print(perm_u_nested)

## 1) Seasonality within Location (permutations blocked within Location)
pw_u_season_given_loc <- pairwise.adonis2(
  distP_u ~ Seasonality,
  data   = metaP,
  strata = "Location",
  p.adjust.m = "BH",
  nperm = 999
)

## 2) Impact within Location (Impact is nested in Location → test within Location)
pw_u_impact_given_loc <- pairwise.adonis2(
  distP_u ~ Impact,
  data   = metaP,
  strata = "Location",
  p.adjust.m = "BH",
  nperm = 999
)


## 3) Impact dins de cada combinació Seasonality × Location
## (subconjunts per cada cel·la de Seasonality × Location; no cal 'strata' perquè Location queda fixat)

library(pairwiseAdonis)

# Clau de subconjunts (Seasonality × Location)
grp <- with(metaP, interaction(Seasonality, Location, drop = TRUE))

pw_u_impact_given_season_loc <- lapply(levels(grp), function(g) {
  idx <- which(grp == g)

  # Si hi ha < 2 nivells d'Impact en el subconjunt, saltem
  if (length(unique(metaP$Impact[idx])) < 2L) {
    return(sprintf("Omet: %s (menys de 2 nivells d'Impact)", g))
  }

  # Subdistància coherent amb el subconjunt
  sub_dist <- as.dist(as.matrix(distP_u)[idx, idx])

  # Subdata
  sub_data <- metaP[idx, , drop = FALSE]

  # Pairwise dins de la cel·la Seasonality × Location
  pairwise.adonis2(
    sub_dist ~ Impact,
    data       = sub_data,
    p.adjust.m = "BH",
    nperm      = 999
  )
})

names(pw_u_impact_given_season_loc) <- levels(grp)

pw_u_impact_given_season_loc



#GRÀFICS!!
# Paquets
library(phyloseq)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggnewscale)

# ========= 0) SUBSET + META (Paracentrotus) =========
psP <- subset_samples(phylo.rare, Species.name %in% c("Paracentrotus lividus","P. lividus"))
psP <- prune_samples(sample_sums(psP) > 0, psP)
psP <- prune_taxa(taxa_sums(psP) > 0, psP)

metaP <- data.frame(sample_data(psP)) %>%
  mutate(
    Impact = dplyr::recode(as.character(Anthropic.influence),
                           "Non Contaminated" = "Lower-impact",
                           "Contaminated"     = "Higher-impact",
                           .default = NA_character_),
    Impact = factor(Impact, levels = c("Lower-impact","Higher-impact")),
    Seasonality = dplyr::recode(as.character(`Seasonality..sampling.effort.order.`),
                                "First"="Spring","Second"="Autumn","Third"="Winter",
                                .default = NA_character_),
    # ordre igual que a Arbacia (Winter → Spring → Autumn)
    Seasonality = factor(Seasonality, levels = c("Winter","Spring","Autumn")),
    Location = factor(Location)
  )

# Escriu metadades a l’objecte
sample_data(psP)$Impact      <- metaP$Impact
sample_data(psP)$Seasonality <- metaP$Seasonality
sample_data(psP)$Location    <- metaP$Location

# Paleta per Season si no existeix
if (!exists("season_pal")) {
  season_pal <- c(Winter = "#4C78A8", Spring = "#72B7B2", Autumn = "#F58518")
}

# ========= 1) (opcional) Transformació relativa =========
psP.rel <- microbiome::transform(psP, "compositional")

# ========= 2) ORDINACIONS =========
ordP_w <- ordinate(psP.rel, method = "PCoA", distance = "wunifrac")
ordP_u <- ordinate(psP.rel, method = "PCoA", distance = "unifrac")

# Helper per percentatges d’eixos
axis_perc <- function(ord){
  rel <- ord$values$Relative_eig
  if (is.null(rel)) rel <- ord$values$Eigenvalues / sum(ord$values$Eigenvalues)
  c(round(100*rel[1],1), round(100*rel[2],1))
}

# ========= 3) Funció generadora del PCoA amb overlay i llegenda dummy =========
make_pcoa_plot <- function(ps_obj, ord, title_txt){
  # dataframe per a ggplot
  pdat <- plot_ordination(ps_obj, ord, type = "samples")$data
  pdat$Seasonality <- factor(pdat$Seasonality, levels = c("Winter","Spring","Autumn"))
  pdat$Impact      <- factor(pdat$Impact, levels = c("Lower-impact","Higher-impact"))
  pdat_hi <- dplyr::filter(pdat, Impact == "Higher-impact")

  # shapes omplibles per Location
  loc_levels <- levels(sample_data(ps_obj)$Location)
  if (is.null(loc_levels)) loc_levels <- unique(pdat$Location)
  base_shapes <- c(21, 24, 22, 25, 23)
  shape_vals <- setNames(base_shapes[seq_len(min(length(base_shapes), length(loc_levels)))], loc_levels)

  # % eixos
  ap <- axis_perc(ord); ax1 <- ap[1]; ax2 <- ap[2]

  # plot
  p <- ggplot(pdat, aes(Axis.1, Axis.2)) +
    stat_ellipse(aes(color = Seasonality, group = Seasonality),
                 type = "norm", level = 0.95, linewidth = 0.8) +
    # base: buits (contorn per Season), shape per Location
    geom_point(aes(color = Seasonality, shape = Location),
               size = 3, stroke = 0.9, fill = NA, alpha = 0.95) +
    # overlay: plens del mateix color per Higher-impact
    geom_point(data = pdat_hi,
               aes(color = Seasonality, fill = Seasonality, shape = Location),
               size = 3, stroke = 0.9, alpha = 0.95) +
    scale_color_manual(values = season_pal, breaks = c("Winter","Spring","Autumn"), name = "Season") +
    scale_fill_manual(values = season_pal, guide = "none") +
    scale_shape_manual(values = shape_vals, name = "Location") +
    labs(
      title = title_txt,
      x = paste0("PCoA1 (", ax1, "%)"),
      y = paste0("PCoA2 (", ax2, "%)")
    ) +
    theme_classic(base_size = 12) +
    theme(plot.title = element_text(face = "bold"))

  # llegenda dummy d’Impact (buit vs ple)
  p + ggnewscale::new_scale_fill() +
    geom_point(
      data = pdat,
      aes(fill = Impact),  # només per a la llegenda d'Impact
      shape = 21, color = "black",
      size = 3, alpha = 0,  # invisible al plot
      inherit.aes = TRUE
    ) +
    scale_fill_manual(
      values = c("Lower-impact" = "white", "Higher-impact" = "black"),
      breaks = c("Lower-impact","Higher-impact"),
      name   = "Impact"
    ) +
    guides(fill = guide_legend(override.aes = list(alpha = 1, shape = 21, size = 3, color = "black")))
}

# ========= 4) Plots Weighted i Unweighted =========
p_pcoaP_w <- make_pcoa_plot(psP.rel, ordP_w,
                            expression(italic("Paracentrotus lividus") ~ " — PCoA (Weighted UniFrac)"))
p_pcoaP_u <- make_pcoa_plot(psP.rel, ordP_u,
                            expression(italic("Paracentrotus lividus") ~ " — PCoA (Unweighted UniFrac)"))

p_pcoaP_w
p_pcoaP_u
```
SIMPER + ENVFIT ARBACIA AND PARACENTROTUS

```{r setup, include=FALSE}
## =======================
## 0) Llibreries i carpeta
## =======================
library(phyloseq)
library(vegan)
library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)
library(forcats)
library(grid)   # per a arrow()

outdir <- "Simper_results"
dir.create(outdir, showWarnings = FALSE)

## =========================================================
## 1) Agregar per FAMÍLIA (evitem duplicats de taxa_names)
## =========================================================
otu <- as(otu_table(phylo.rare), "matrix")
if (!taxa_are_rows(phylo.rare)) otu <- t(otu)  # TAXA a files

tax <- as(tax_table(phylo.rare), "matrix")
fam_vec <- tax[, "Family"]
fam_vec[is.na(fam_vec) | fam_vec == ""] <- "Unassigned"

# Agreguem comptatges per família (files = famílies)
otu_fam <- rowsum(otu, fam_vec, reorder = FALSE)

# Construïm un phyloseq a nivell família
ps_fam <- phyloseq(
  otu_table(otu_fam, taxa_are_rows = TRUE),
  sample_data(sample_data(phylo.rare))
)
tax_fam <- matrix(rownames(otu_fam), ncol = 1,
                  dimnames = list(rownames(otu_fam), "Family"))
tax_table(ps_fam) <- tax_table(tax_fam)

# Neteja bàsica
ps_fam <- prune_taxa(taxa_sums(ps_fam) > 0, ps_fam)
sample_data(ps_fam)$Season <- factor(sample_data(ps_fam)$Season,
                                     levels = c("Winter","Spring","Autumn"))

## =========================================================
## 3) ARBACIA LIXULA — PCoA + envfit + Top15 per Season
## =========================================================
# Mostres d'Arbacia
psA <- prune_samples(sample_data(ps_fam)$Species.name == "Arbacia lixula", ps_fam)
psA <- prune_taxa(taxa_sums(psA) > 0, psA)

# Relatives
psA_rel <- transform_sample_counts(psA, function(x) x / sum(x))

# Matriu (SAMPLES x FAMÍLIES)
matA <- as(otu_table(psA_rel), "matrix")
if (taxa_are_rows(psA_rel)) matA <- t(matA)

# PCoA + coords
ordA    <- vegan::capscale(matA ~ 1, distance = "bray")
coordsA <- as.data.frame(vegan::scores(ordA, display = "sites"))[, 1:2, drop = FALSE]
colnames(coordsA) <- c("Axis1", "Axis2")
coordsA$Season   <- sample_data(psA_rel)$Season
coordsA$Location <- sample_data(psA_rel)$Location

# ENVFIT famílies (filtra columnes amb variança zero)
commA <- as.data.frame(matA)
if (ncol(commA) > 0) {
  keepA <- apply(commA, 2, sd) > 0
  if (any(keepA)) commA <- commA[, keepA, drop = FALSE]
}
vecA <- NULL
if (ncol(commA) > 1) {
  vfitA <- vegan::envfit(ordA, commA, permutations = 999)
  tmp   <- try(as.data.frame(vegan::scores(vfitA, display = "vectors")), silent = TRUE)
  if (!inherits(tmp, "try-error") && nrow(tmp) > 0) {
    colnames(tmp)[1:2] <- c("Axis1","Axis2")
    tmp$Family <- rownames(tmp)
    tmp$p  <- vfitA$vectors$pvals
    tmp$r2 <- vfitA$vectors$r
    tmp <- tmp %>% arrange(p, desc(r2)) %>% filter(p < 0.05) %>% slice_head(n = 8)
    if (nrow(tmp) > 0) {
      # ===== Escalat manual de fletxes perquè càpiguen al rang del PCoA =====
      xr <- diff(range(coordsA$Axis1, na.rm = TRUE))
      yr <- diff(range(coordsA$Axis2, na.rm = TRUE))
      maxvx <- max(abs(tmp$Axis1), na.rm = TRUE)
      maxvy <- max(abs(tmp$Axis2), na.rm = TRUE)
      if (is.finite(maxvx) && maxvx > 0 && is.finite(maxvy) && maxvy > 0) {
        multA <- 0.9 * min(xr / (2 * maxvx), yr / (2 * maxvy))
      } else {
        multA <- 1
      }
      tmp$Axis1s <- tmp$Axis1 * multA
      tmp$Axis2s <- tmp$Axis2 * multA
      vecA <- tmp
    }
  }
}

# Elipses per Season (només grups amb ≥3 mostres)
ellA_ok <- coordsA %>% count(Season) %>% filter(n >= 3) %>% pull(Season)

# GRÀFIC PCoA amb fletxes i elipses
gA <- ggplot(coordsA, aes(Axis1, Axis2)) +
  geom_point(aes(color = Season, shape = Location), size = 3, alpha = .85) +
  theme_bw(base_size = 12) +
  labs(
    title = bquote("PCoA Bray–Curtis — " * italic(Arbacia~lixula)),
    x = "PCoA1", y = "PCoA2"
  )
if (length(ellA_ok) > 0) {
  gA <- gA +
    stat_ellipse(
      data = coordsA %>% filter(Season %in% ellA_ok),
      aes(color = Season), type = "t", linewidth = 0.6
    )
}
if (!is.null(vecA) && nrow(vecA) > 0) {
  gA <- gA +
    geom_segment(data = vecA,
                 aes(x = 0, y = 0, xend = Axis1s, yend = Axis2s),
                 arrow = arrow(length = unit(0.22, "cm"))) +
    geom_text(data = vecA,
              aes(x = Axis1s, y = Axis2s, label = Family),
              vjust = -0.35, size = 3)
}
ggsave(file.path(outdir, "PCoA_envfit_Arbacia.png"),
       gA, width = 8, height = 6.5, dpi = 300)

# TOP-15 per SEASON (mitjana d’abundància relativa)
sdatA <- as(sample_data(psA_rel), "data.frame")
dfA <- as.data.frame(matA)
dfA$Sample <- rownames(dfA)
dfA <- dfA %>% mutate(Season = sdatA[Sample, "Season", drop = TRUE])

longA <- dfA %>%
  pivot_longer(cols = -c(Sample, Season),
               names_to = "Family", values_to = "abund")

meansA <- longA %>%
  group_by(Season, Family) %>%
  summarise(average = mean(abund, na.rm = TRUE), .groups = "drop")

topA <- meansA %>%
  group_by(Season) %>%
  arrange(desc(average), .by_group = TRUE) %>%
  slice_head(n = 15) %>%
  ungroup()

# CSVs Arbacia
write_csv(topA %>% arrange(Season, desc(average)),
          file.path(outdir, "SIMPER_Arbacia_top15_bySeason_families.csv"))
for (sea in unique(na.omit(topA$Season))) {
  write_csv(filter(topA, Season == sea) %>% arrange(desc(average)),
            file.path(outdir, paste0("SIMPER_Arbacia_top15_", sea, "_families.csv")))
}

# GRÀFICS Top-15 Arbacia (un per season) — títol amb cursiva
for (sea in unique(na.omit(topA$Season))) {
  dat <- filter(topA, Season == sea) %>%
    mutate(Family = fct_reorder(Family, average))
  p <- ggplot(dat, aes(x = Family, y = average, fill = Family)) +
    geom_col() +
    coord_flip() +
    theme_bw(base_size = 12) + guides(fill = "none") +
    labs(
      title = bquote(italic(Arbacia~lixula) ~ " — Top 15 famílies (" * .(sea) * ")"),
      x = NULL, y = "Mitjana abundància relativa"
    )
  ggsave(file.path(outdir, paste0("Top15_Arbacia_", sea, ".png")),
         p, width = 7, height = 6, dpi = 300)
}

## =============================================================
## 4) PARACENTROTUS LIVIDUS — PCoA + envfit + Top15 per Season
## =============================================================
# Mostres de Paracentrotus
psP <- prune_samples(sample_data(ps_fam)$Species.name == "Paracentrotus lividus", ps_fam)
psP <- prune_taxa(taxa_sums(psP) > 0, psP)

# Relatives
psP_rel <- transform_sample_counts(psP, function(x) x / sum(x))

# Matriu (SAMPLES x FAMÍLIES)
matP <- as(otu_table(psP_rel), "matrix")
if (taxa_are_rows(psP_rel)) matP <- t(matP)

# PCoA + coords
ordP    <- vegan::capscale(matP ~ 1, distance = "bray")
coordsP <- as.data.frame(vegan::scores(ordP, display = "sites"))[, 1:2, drop = FALSE]
colnames(coordsP) <- c("Axis1", "Axis2")
coordsP$Season   <- sample_data(psP_rel)$Season
coordsP$Location <- sample_data(psP_rel)$Location

# ENVFIT famílies
commP <- as.data.frame(matP)
if (ncol(commP) > 0) {
  keepP <- apply(commP, 2, sd) > 0
  if (any(keepP)) commP <- commP[, keepP, drop = FALSE]
}
vecP <- NULL
if (ncol(commP) > 1) {
  vfitP <- vegan::envfit(ordP, commP, permutations = 999)
  tmpP  <- try(as.data.frame(vegan::scores(vfitP, display = "vectors")), silent = TRUE)
  if (!inherits(tmpP, "try-error") && nrow(tmpP) > 0) {
    colnames(tmpP)[1:2] <- c("Axis1","Axis2")
    tmpP$Family <- rownames(tmpP)
    tmpP$p  <- vfitP$vectors$pvals
    tmpP$r2 <- vfitP$vectors$r
    tmpP <- tmpP %>% arrange(p, desc(r2)) %>% filter(p < 0.05) %>% slice_head(n = 8)
    if (nrow(tmpP) > 0) {
      # ===== Escalat manual de fletxes =====
      xr <- diff(range(coordsP$Axis1, na.rm = TRUE))
      yr <- diff(range(coordsP$Axis2, na.rm = TRUE))
      maxvx <- max(abs(tmpP$Axis1), na.rm = TRUE)
      maxvy <- max(abs(tmpP$Axis2), na.rm = TRUE)
      if (is.finite(maxvx) && maxvx > 0 && is.finite(maxvy) && maxvy > 0) {
        multP <- 0.9 * min(xr / (2 * maxvx), yr / (2 * maxvy))
      } else {
        multP <- 1
      }
      tmpP$Axis1s <- tmpP$Axis1 * multP
      tmpP$Axis2s <- tmpP$Axis2 * multP
      vecP <- tmpP
    }
  }
}

# Elipses per Season
ellP_ok <- coordsP %>% count(Season) %>% filter(n >= 3) %>% pull(Season)

# GRÀFIC PCoA amb fletxes i elipses
gP <- ggplot(coordsP, aes(Axis1, Axis2)) +
  geom_point(aes(color = Season, shape = Location), size = 3, alpha = .85) +
  theme_bw(base_size = 12) +
  labs(
    title = bquote("PCoA Bray–Curtis — " * italic(Paracentrotus~lividus)),
    x = "PCoA1", y = "PCoA2"
  )
if (length(ellP_ok) > 0) {
  gP <- gP +
    stat_ellipse(
      data = coordsP %>% filter(Season %in% ellP_ok),
      aes(color = Season), type = "t", linewidth = 0.6
    )
}
if (!is.null(vecP) && nrow(vecP) > 0) {
  gP <- gP +
    geom_segment(data = vecP,
                 aes(x = 0, y = 0, xend = Axis1s, yend = Axis2s),
                 arrow = arrow(length = unit(0.22, "cm"))) +
    geom_text(data = vecP,
              aes(x = Axis1s, y = Axis2s, label = Family),
              vjust = -0.35, size = 3)
}
ggsave(file.path(outdir, "PCoA_envfit_Paracentrotus.png"),
       gP, width = 8, height = 6.5, dpi = 300)

# TOP-15 per SEASON
sdatP <- as(sample_data(psP_rel), "data.frame")
dfP <- as.data.frame(matP)
dfP$Sample <- rownames(dfP)
dfP <- dfP %>% mutate(Season = sdatP[Sample, "Season", drop = TRUE])

longP <- dfP %>%
  pivot_longer(cols = -c(Sample, Season),
               names_to = "Family", values_to = "abund")

meansP <- longP %>%
  group_by(Season, Family) %>%
  summarise(average = mean(abund, na.rm = TRUE), .groups = "drop")

topP <- meansP %>%
  group_by(Season) %>%
  arrange(desc(average), .by_group = TRUE) %>%
  slice_head(n = 15) %>%
  ungroup()

# CSVs Paracentrotus
write_csv(topP %>% arrange(Season, desc(average)),
          file.path(outdir, "SIMPER_Paracentrotus_top15_bySeason_families.csv"))
for (sea in unique(na.omit(topP$Season))) {
  write_csv(filter(topP, Season == sea) %>% arrange(desc(average)),
            file.path(outdir, paste0("SIMPER_Paracentrotus_top15_", sea, "_families.csv")))
}

# GRÀFICS Top-15 Paracentrotus (títol amb cursiva)
for (sea in unique(na.omit(topP$Season))) {
  dat <- filter(topP, Season == sea) %>%
    mutate(Family = fct_reorder(Family, average))
  p <- ggplot(dat, aes(x = Family, y = average, fill = Family)) +
    geom_col() +
    coord_flip() +
    theme_bw(base_size = 12) + guides(fill = "none") +
    labs(
      title = bquote(italic(Paracentrotus~lividus) ~ " — Top 15 famílies (" * .(sea) * ")"),
      x = NULL, y = "Mitjana abundància relativa"
    )
  ggsave(file.path(outdir, paste0("Top15_Paracentrotus_", sea, ".png")),
         p, width = 7, height = 6, dpi = 300)
}